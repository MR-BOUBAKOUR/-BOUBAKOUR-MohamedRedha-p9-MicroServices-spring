<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OAuth2SuccessHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">gateway</a> &gt; <a href="index.source.html" class="el_package">com.MedilaboSolutions.gateway.security</a> &gt; <span class="el_source">OAuth2SuccessHandler.java</span></div><h1>OAuth2SuccessHandler.java</h1><pre class="source lang-java linenums">package com.MedilaboSolutions.gateway.security;

import com.MedilaboSolutions.gateway.dto.OAuth2UserInfo;
import com.MedilaboSolutions.gateway.service.UserService;
import com.MedilaboSolutions.gateway.utils.AuthUtil;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseCookie;
import org.springframework.security.core.Authentication;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.security.web.server.WebFilterExchange;
import org.springframework.security.web.server.authentication.ServerAuthenticationSuccessHandler;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

import java.net.URI;
import java.time.Duration;
import java.util.Map;

<span class="fc" id="L23">@Slf4j</span>
@Component
@RequiredArgsConstructor
public class OAuth2SuccessHandler implements ServerAuthenticationSuccessHandler {

    @Value(&quot;${jwt.accessTokenExpirationMs}&quot;)
    private long accessTokenExpirationMs;

    @Value(&quot;${jwt.refreshTokenExpirationMs}&quot;)
    private long refreshTokenExpirationMs;

    @Value(&quot;${cors.frontend-success-url}&quot;)
    private String frontendSuccessUrl;

    @Value(&quot;${cors.frontend-error-url}&quot;)
    private String frontendErrorUrl;

    private final AuthUtil authUtil;
    private final UserService userService;

    @Override
    public Mono&lt;Void&gt; onAuthenticationSuccess(WebFilterExchange webFilterExchange, Authentication authentication) {

<span class="nc" id="L46">        OAuth2User oauth2User = (OAuth2User) authentication.getPrincipal();</span>
<span class="nc" id="L47">        Map&lt;String, Object&gt; attributes = oauth2User.getAttributes();</span>

<span class="nc" id="L49">        OAuth2UserInfo userInfo = OAuth2UserInfo.fromGoogleAttributes(attributes);</span>
<span class="nc" id="L50">        String username = userInfo.getName();</span>
<span class="nc" id="L51">        String pictureUrl = userInfo.getPictureUrl();</span>

<span class="nc" id="L53">        ServerWebExchange exchange = webFilterExchange.getExchange();</span>

<span class="nc" id="L55">        return userService.findByUsername(username)</span>
<span class="nc" id="L56">                .switchIfEmpty(Mono.error(new RuntimeException(&quot;User not found&quot;)))</span>
<span class="nc" id="L57">                .flatMap(user -&gt; userService.updateUserPicture(user, pictureUrl).thenReturn(user))</span>
<span class="nc" id="L58">                .flatMap(user -&gt; {</span>
<span class="nc" id="L59">                    String role = &quot;ROLE_&quot; + user.getRole();</span>
<span class="nc" id="L60">                    String accessToken = authUtil.generateAccessToken(username, role, user.getUrlPicture());</span>
<span class="nc" id="L61">                    String refreshToken = authUtil.generateRefreshToken(username);</span>

<span class="nc" id="L63">                    ResponseCookie refreshCookie = ResponseCookie.from(&quot;refreshToken&quot;, refreshToken)</span>
<span class="nc" id="L64">                            .httpOnly(true)</span>
<span class="nc" id="L65">                            .secure(true)</span>
<span class="nc" id="L66">                            .sameSite(&quot;None&quot;)</span>
<span class="nc" id="L67">                            .maxAge(Duration.ofMillis(refreshTokenExpirationMs))</span>
<span class="nc" id="L68">                            .path(&quot;/&quot;)</span>
<span class="nc" id="L69">                            .build();</span>

<span class="nc" id="L71">                    exchange.getResponse().addCookie(refreshCookie);</span>

<span class="nc" id="L73">                    String redirectUrl = String.format(&quot;%s?token=%s&amp;expires=%d&quot;,</span>
<span class="nc" id="L74">                            frontendSuccessUrl, accessToken, accessTokenExpirationMs);</span>

<span class="nc" id="L76">                    log.info(&quot;OAuth2 authentication success for user: {}&quot;, username);</span>

<span class="nc" id="L78">                    exchange.getResponse().setStatusCode(HttpStatus.FOUND);</span>
<span class="nc" id="L79">                    exchange.getResponse().getHeaders().setLocation(URI.create(redirectUrl));</span>
<span class="nc" id="L80">                    return exchange.getResponse().setComplete();</span>
                })
<span class="nc" id="L82">                .onErrorResume(ex -&gt; {</span>
<span class="nc" id="L83">                    log.warn(&quot;Unauthorized OAuth2 login attempt for unknown user: {}&quot;, username);</span>
<span class="nc" id="L84">                    String redirectUrl = frontendErrorUrl + &quot;?error=oauth2_unknown_user&quot;;</span>
<span class="nc" id="L85">                    exchange.getResponse().setStatusCode(HttpStatus.FOUND);</span>
<span class="nc" id="L86">                    exchange.getResponse().getHeaders().setLocation(URI.create(redirectUrl));</span>
<span class="nc" id="L87">                    return exchange.getResponse().setComplete();</span>
                });
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>